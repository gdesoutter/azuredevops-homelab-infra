trigger:
- main

#trigger: none

name: 'Deploy-Hybrid-Lab-$(Date:yyyyMMdd)$(Rev:.r)'

variables:
  # --- CONFIGURATION GÉNÉRALE ---
  azureServiceConnection: 'Azure-Subscription-Conn' 
  resourceGroupName: 'RG-HYBRID-LAB'
  location: 'westeurope'
  
  # Chemins des dossiers 
  terraformDirectory: '$(System.DefaultWorkingDirectory)/terraform'
  bicepFile: 'bicep/main.bicep'

  # --- CONFIGURATION BACKEND TERRAFORM ---
  tfBackendResourceGroup: 'RG-TERRAFORM-STATE'
  tfBackendStorageAccount: 'tfstatelabguillaume' 
  tfBackendContainer: 'tfstate'
  tfBackendKey: 'hyperv-lab.tfstate'

pool:
  name: 'Default' 
  demands:
  - agent.name -equals HOMELAB-WSTOOLS # On force l'exécution sur TA machine

stages:
  # ------------------------------------------------------------------
  # STAGE 1 : INFRASTRUCTURE (TERRAFORM)
  # Crée la VM, le Disque Différencié, et installe l'Agent Arc via WinRM
  # ------------------------------------------------------------------
  - stage: Terraform_Deploy
    displayName: 'Deploy Infrastructure (Hyper-V)'
    jobs:
      - job: ProvisionVM
        displayName: 'Terraform Apply'
        steps:
          # 1. Récupération des secrets pour HYPER-V et AZURE SPN
          - task: AzureKeyVault@2
            displayName: 'Get Secrets from KV'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              KeyVaultName: 'KV-labguillaume' 
              # Liste des secrets à récupérer
              SecretsFilter: 'hyperv-password,vm-admin-password,spn-client-id,spn-client-secret,spn-tenant-id,spn-subscription-id'
              RunAsPreJob: true

          # 2. Installation de Terraform
          - task: TerraformInstaller@0
            displayName: 'Install Terraform'
            inputs:
              terraformVersion: 'latest'

          # 3. Init (Connexion au Backend Azure)
          - task: TerraformTaskV4@4
            displayName: 'Terraform Init'
            inputs:
              provider: 'azurerm'
              command: 'init'
              workingDirectory: '$(terraformDirectory)' 
              backendServiceArm: '$(azureServiceConnection)'
              backendAzureRmResourceGroupName: '$(tfBackendResourceGroup)'
              backendAzureRmStorageAccountName: '$(tfBackendStorageAccount)'
              backendAzureRmContainerName: '$(tfBackendContainer)'
              backendAzureRmKey: '$(tfBackendKey)'

          # 4. Plan & Apply
          # On injecte les secrets du KV dans les variables TF_VAR_
          - task: TerraformTaskV4@4
            displayName: 'Terraform Apply'
            inputs:
              provider: 'azurerm'
              command: 'apply'
              workingDirectory: '$(terraformDirectory)'
              environmentServiceNameAzureRM: '$(azureServiceConnection)'
              commandOptions: '-auto-approve'
            env:
              # Mapping Secrets KV -> Variables Terraform
              TF_VAR_hyperv_host: '192.168.1.20'
              TF_VAR_hyperv_user: 'Administrateur'
              TF_VAR_hyperv_password: $(hyperv-password)       
              TF_VAR_vm_admin_password: $(vm-admin-password)
              TF_VAR_client_id: $(spn-client-id)               
              TF_VAR_client_secret: $(spn-client-secret)       
              TF_VAR_tenant_id: $(spn-tenant-id)               
              TF_VAR_subscription_id: $(spn-subscription-id)   
              TF_VAR_resource_group: $(resourceGroupName)
              TF_VAR_location: $(location)

          # 5. Export du nom de la VM pour l'étape suivante
          - powershell: |
              # On récupère l'output défini dans outputs.tf
              $vmName = terraform output -raw vm_name
              Write-Host "Machine déployée : $vmName"
              # On la passe à Azure DevOps pour le stage suivant
              Write-Host "##vso[task.setvariable variable=vmName;isOutput=true]$vmName"
            workingDirectory: '$(terraformDirectory)'
            displayName: 'Export VM Name'
            name: 'TFOutput'

  # ------------------------------------------------------------------
  # STAGE 2 : CONFIGURATION (BICEP)
  # Configure la machine Arc (DSC Domain Join)
  # ------------------------------------------------------------------
  - stage: Bicep_Config
    displayName: 'Configure Arc Machine'
    dependsOn: Terraform_Deploy
    condition: succeeded()
    variables:
      vmName: $[ stageDependencies.Terraform_Deploy.ProvisionVM.outputs['TFOutput.vmName'] ]
    jobs:
      - job: ConfigureDSC
        steps:
          # 1. Récupération des secrets DOMAINE
          - task: AzureKeyVault@2
            displayName: 'Get Domain Secrets'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              KeyVaultName: 'KV-LAB-01'
              SecretsFilter: 'DomainJoinUsername,DomainJoinPassword,StorageAccountKey'
              RunAsPreJob: true

          # 2. Déploiement Bicep
          - task: AzureCLI@2
            displayName: 'Deploy DSC Extension'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'pscore'
              scriptLocation: 'inlineScript'
              inlineScript: |
                Write-Host "Application de la configuration sur : $(vmName)"
                
                az deployment group create `
                  --resource-group $(resourceGroupName) `
                  --template-file bicep/main.bicep `
                  --parameters vmName=$(vmName) `
                               storageAccountName='tfstatelabguillaume' `
                               storageAccountKey='$(StorageAccountKey)' `
                               domainJoinUser='$(DomainJoinUsername)' `
                               domainJoinPassword='$(DomainJoinPassword)'