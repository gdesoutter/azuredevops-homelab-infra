trigger:
- main

name: 'Deploy-Hybrid-Lab-$(Date:yyyyMMdd)$(Rev:.r)'

variables:
  azureServiceConnection: 'Azure-Subscription-Conn' 
  resourceGroupName: 'RG-HYBRID-LAB'
  location: 'francecentral' # Aligné sur ton test manuel réussi
  terraformDirectory: '$(System.DefaultWorkingDirectory)/terraform'
  bicepFile: 'bicep/main.bicep'
  tfBackendResourceGroup: 'RG-TERRAFORM-STATE'
  tfBackendStorageAccount: 'tfstatelabguillaume' 
  tfBackendContainer: 'tfstate'
  tfBackendKey: 'hyperv-lab.tfstate'

pool:
  name: 'Default' 
  demands:
  - agent.name -equals HOMELAB-WSTOOLS

stages:
  # STAGE 1 : TERRAFORM (Infrastructure & Agent Arc)
  - stage: Terraform_Deploy
    displayName: 'Deploy Infrastructure'
    jobs:
      - job: ProvisionVM
        displayName: 'Terraform Apply'
        steps:
          - task: AzureKeyVault@2
            displayName: 'Get Secrets'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              KeyVaultName: 'KV-labguillaume' 
              SecretsFilter: 'hyperv-password,vm-admin-password,spn-client-id,spn-client-secret,spn-tenant-id,spn-subscription-id'
              RunAsPreJob: true

          - task: TerraformInstaller@0
            displayName: 'Install Terraform'
            inputs:
              terraformVersion: 'latest'

          - task: TerraformTaskV4@4
            displayName: 'Terraform Init'
            inputs:
              provider: 'azurerm'
              command: 'init'
              workingDirectory: '$(terraformDirectory)' 
              backendServiceArm: '$(azureServiceConnection)'
              backendAzureRmResourceGroupName: '$(tfBackendResourceGroup)'
              backendAzureRmStorageAccountName: '$(tfBackendStorageAccount)'
              backendAzureRmContainerName: '$(tfBackendContainer)'
              backendAzureRmKey: '$(tfBackendKey)'

          - task: TerraformTaskV4@4
            displayName: 'Terraform Apply'
            inputs:
              provider: 'azurerm'
              command: 'apply'
              workingDirectory: '$(terraformDirectory)'
              environmentServiceNameAzureRM: '$(azureServiceConnection)'
              commandOptions: '-auto-approve'
            env:
              TF_VAR_hyperv_host: '192.168.1.120'
              TF_VAR_hyperv_user: 'Administrateur'
              TF_VAR_hyperv_password: $(hyperv-password)       
              TF_VAR_vm_admin_password: $(vm-admin-password)
              TF_VAR_client_id: $(spn-client-id)               
              TF_VAR_client_secret: $(spn-client-secret)       
              TF_VAR_tenant_id: $(spn-tenant-id)               
              TF_VAR_subscription_id: $(spn-subscription-id)   
              TF_VAR_resource_group: $(resourceGroupName)
              TF_VAR_location: $(location)

          - powershell: |
              $vmName = terraform output -raw vm_name
              Write-Host "##vso[task.setvariable variable=vmName;isOutput=true]$vmName"
            workingDirectory: '$(terraformDirectory)'
            displayName: 'Export VM Name'
            name: 'TFOutput'

  # STAGE 2 : BICEP (Configuration DSC)
  - stage: Bicep_Config
    displayName: 'Configure Arc Machine'
    dependsOn: Terraform_Deploy
    condition: succeeded()
    variables:
      vmName: $[ stageDependencies.Terraform_Deploy.ProvisionVM.outputs['TFOutput.vmName'] ]
    jobs:
      - job: ConfigureDSC
        steps:
          # Pause cruciale pour l'indexation ARM (Évite l'erreur HCRP404)
          - powershell: |
              Write-Host "Attente de 120s pour la propagation d'Azure Arc de $(vmName)..."
              Start-Sleep -Seconds 120
            displayName: 'Wait for Arc Propagation'

          - task: AzureKeyVault@2
            displayName: 'Get Domain Secrets'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              KeyVaultName: 'KV-labguillaume'
              SecretsFilter: 'DomainJoinUsername,DomainJoinPassword' 
              RunAsPreJob: true

          - task: AzureCLI@2
            displayName: 'Generate SAS and Deploy Bicep'
            inputs:
              azureSubscription: '$(azureServiceConnection)'
              scriptType: 'pscore'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # 1. Génération de l'URL SAS sécurisée pour le ZIP
                $expiry = (Get-Date).AddHours(2).ToString("yyyy-MM-ddTHH:mm:ssZ")
                $fullSasUrl = az storage blob generate-sas `
                  --account-name tfstatelabguillaume `
                  --container-name dsc-configs `
                  --name DomainJoin.zip `
                  --permissions r `
                  --expiry $expiry `
                  --full-uri `
                  --output tsv
                
                Write-Host "SAS URL générée avec succès."

                # 2. Déploiement Bicep
                az deployment group create `
                  --resource-group $(resourceGroupName) `
                  --template-file bicep/main.bicep `
                  --parameters vmName=$(vmName) `
                               domainJoinUser='$(DomainJoinUsername)' `
                               domainJoinPassword='$(DomainJoinPassword)' `
                               dscZipUrl="$fullSasUrl"